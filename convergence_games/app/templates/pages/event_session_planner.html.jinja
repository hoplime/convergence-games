<Page>
    {% block content %}
        <title>{{ event.name }} Session Planner - Convergence 2025</title>
        <PageContainer size="max-w-screen-2xl">
            <h2 class="text-xl">{{ event.name }} Session Planner</h2>
            <div class="tabs-border tabs tabs-sm">
                <div class="inline-flex h-8 items-center justify-center text-sm">
                    <span class="icon-[mdi--clock]"></span>
                </div>
                {% for time_slot in event.time_slots %}
                    <input
                        type="radio"
                        name="time_slot_selector"
                        class="tab"
                        aria-label="{{ 'Session ' ~ loop.index }}"
                        {{ "checked" if selected_time_slot.id == time_slot.id }}
                        hx-get="/event/{{ swim(event) }}/planner/{{ swim(time_slot) }}"
                        hx-params="none"
                        hx-target="#game_list"
                        hx-replace-url="true"
                        hx-trigger="click, htmx:load from:next"
                    />
                    <div class="tab-content rounded-box border border-base-300 bg-base-200 p-4" hx-disinherit="*">
                        <div class="flex flex-col gap-2">
                            <div>
                                {{ time_slot.name }} @
                                <span class="italic"
                                    ><TimeDisplay :time="time_slot.start_time" /> -
                                    <TimeDisplay :time="time_slot.end_time"
                                /></span>
                            </div>
                            <div hx-get="/party/overview/{{ swim(time_slot) }}" hx-trigger="intersect once"></div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div>
                <div class="collapse-plus collapse border border-base-300 bg-base-100">
                    <input type="checkbox" />
                    <div class="collapse-title font-semibold">Preferences & Tier Explanation</div>
                    <div class="collapse-content flex flex-col gap-2">
                        <p class="italic">
                            Below is a preview of the ranked tier list of games running this session, according to your
                            or your party leader's preferences (dice ratings). Games within each tier are equally
                            weighted.
                        </p>
                        <p class="italic">
                            The allocation algorithm will try to place you in the highest tier possible, while making
                            sure as many games run at optimal player counts.
                        </p>
                        <p class="italic">
                            Try to make sure you accurately represent your preferences with a good selection of games in
                            the first few tiers - cheating the system with one D12 and all D0s will possibly mean you
                            can't get into a game at all!
                        </p>
                        <p class="italic">
                            Your preference for a game is shared
                            <span class="font-semibold">across all sessions</span> - if you really want to get into a
                            game with limited sessions and a game running in all five sessions, consider adjusting your
                            preferences between sessions.
                        </p>
                    </div>
                </div>
            </div>
            {% block game_list %}
                <div id="game_list">
                    {% if party_leader.id != request.user.id %}
                        <div>You are not the party leader - showing {{ party_leader.first_name }}'s preferences.</div>
                    {% endif %}
                    <div class="flex flex-col gap-4">
                        {% set tier_list_offset = 1 if game_tier_list and game_tier_list[0][0].name == "GM" else 0 %}
                        {% for tier, games in game_tier_list %}
                            <div class="sticky top-0 z-10 bg-base-100">
                                <div class="divider divider-vertical">
                                    <div class="flex flex-col gap-0">
                                        <div class="flex flex-row gap-4 text-xl font-semibold">
                                            {% if tier.name not in ['D0', 'AGE_RESTRICTED', 'GM'] %}
                                                <div>Tier {{ loop.index - tier_list_offset }}</div>
                                            {% endif %}
                                            <div class="{{ tier.display_class }}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                                {% for game in games %}
                                    <GameCard
                                        :game="game"
                                        :preference="preferences.get(game.id)"
                                        :all_party_members_over_18="all_party_members_over_18"
                                    />
                                {% endfor %}
                            </div>

                            {% if tier.name == "GM" %}
                                <div>
                                    You are scheduled to GM a game this session - however, if we are unable to allocate
                                    enough players to your game, you will be allocated as a player based on your
                                    preferences.
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endblock %}
        </PageContainer>
    {% endblock content %}
</Page>
