{#def
    time_slot: TimeSlot,
    party: Party | None = None,
    leader_id: int | None = None,
    max_party_size: int = 3,
    checked_in: bool = False,
    is_gm: bool = False,
    allocated_session: Session | None = None,
    allocated_session_players: list[User] = [],
#}
<div {{ attrs.render(class="card-body party-overview p-0") }} hx-target="this">
    {# Check In #}
    {% if time_slot.checkin_open_time and utcnow() < time_slot.checkin_open_time %}
        {# STATE = Check in closed #}
        <span>Check in opens @ <TimeDisplay :time="time_slot.checkin_open_time" :date="true" /></span>
    {% else %}
        {# STATE = Check in closed #}
        {% if party is not none and request.user.id != leader_id %}
            {# STATE = In party, not leader #}
            {# Determine if leader is checked in #}
            {% set ns = namespace(leader_checked_in=false) %}
            {% for member in party.members %}
                {% if member.id == leader_id and member.checkin_statuses and member.checkin_statuses[0].checked_in %}
                    {% set ns.leader_checked_in = true %}
                {% endif %}
            {% endfor %}
            <span class="text-sm">Your party leader should check in if you are available to play this session.</span>
            {% if ns.leader_checked_in %}
                <span class="text-success"
                    ><span class="icon-[material-symbols--check]"></span> Your party leader is checked in.</span
                >
            {% else %}
                <span class="text-warning"
                    ><span class="icon-[material-symbols--close]"></span> Your party leader is not checked in.</span
                >
            {% endif %}
        {% elif checked_in %}
            {# STATE = Solo or leader, checked in #}
            <span class="text-sm">Check in if you are available to play {{ "or GM" if is_gm }} in this session.</span>
            <div class="card-actions items-center justify-start">
                {% if time_slot.status not in ['Allocating', 'Allocated'] %}
                    <button
                        class="btn btn-sm btn-error"
                        hx-post="/party/checkout/{{ swim(time_slot) }}"
                        hx-confirm="Are you sure you want to check out?"
                    >
                        Check Out
                    </button>
                {% else %}
                    <button class="btn-disabled btn btn-sm" disabled>Check Out (Locked)</button>
                {% endif %}
                <span class="text-success"
                    ><span class="icon-[material-symbols--check]"></span> You are checked in.</span
                >
            </div>
        {% else %}
            {# STATE = Solo or leader, not checked in #}
            <span class="text-sm">Check in if you are available to play {{ "or GM" if is_gm }} in this session.</span>
            <div class="card-actions items-center justify-start">
                {% if time_slot.status not in ['Allocating', 'Allocated'] %}
                    <button class="btn btn-sm btn-primary" hx-post="/party/checkin/{{ swim(time_slot) }}">
                        Check In
                    </button>
                {% else %}
                    <button class="btn-disabled btn btn-sm" disabled>Check In (Locked)</button>
                {% endif %}
                <span class="text-warning"
                    ><span class="icon-[material-symbols--close]"></span> You are not checked in.</span
                >
            </div>
        {% endif %}
    {% endif %}

    {# Allocated Session #}
    {% if allocated_session is not none %}
        <div class="divider m-0 divider-vertical"></div>
        <div class="flex h-full flex-col gap-4">
            <div>
                <span>You are in...</span>
                <h2 class="card-title">{{ allocated_session.game.name }}</h2>
                <span>{{ allocated_session.game.system.name }}</span>
            </div>
            <span>{{ allocated_session.table.room.name }}, {{ allocated_session.table.name }}</span>
            <ul class="list-inside list-disc space-y-1">
                {% for player in allocated_session_players %}
                    <li>
                        {{ player.full_name }}{% if player.id == allocated_session.game.gamemaster_id %}
                            <div class="badge">GM</div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% elif allocated_session is none and time_slot.status == 'Allocated' and checked_in %}
        <div class="divider m-0 divider-vertical"></div>
        <span class="text-warning">You were not allocated a game for this session.</span>
        <div class="flex h-full flex-col gap-4">
            <h2 class="card-title">You are in Overflow</h2>
            <span>This was likely caused by everybody's preferences being impossible to satisfy by the algorithm.</span>
            <span>Please see the event organisers, and we'll sort you out with a game.</span>
        </div>
    {% endif %}

    {# Party #}
    <div class="divider m-0 divider-vertical"></div>
    {% if party %}
        {% set invite_link = "/party/join/" ~ swim(time_slot) ~ "/" ~ swim_upper(party) %}
        <div class="grid grid-cols-1 gap-x-4 md:grid-cols-[1fr_16rem]">
            <div class="flex h-full flex-col gap-4">
                <div class="flex flex-row justify-between">
                    <h2 class="card-title">
                        {% if request.user.id == leader_id %}Leading{% else %}In{% endif %} a Party
                    </h2>

                    <div class="flex flex-wrap content-end items-center justify-end gap-x-2">
                        <div>
                            <span class="opacity-50">Players: </span>
                            <span class="font-semibold">{{ party.members|length }}/{{ max_party_size }}</span>
                        </div>
                        <div>
                            <span class="opacity-50">Join Code: </span>
                            <span class="font-semibold">{{ swim_upper(party) }}</span>
                        </div>
                    </div>
                </div>
                {% if is_gm %}
                    <span class="text-warning"
                        >Woops, here be dragons! You somehow managed to get into a party as a GM this session! Maybe the
                        schedule changed. Please remove yourself from this party, otherwise you will be removed from
                        this party before allocations.</span
                    >
                {% endif %}
                {% if time_slot.status == 'Allocating' %}
                    <span>Allocating - party changes are locked</span>
                {% elif time_slot.status == 'Allocated' %}
                    <span>Allocated - party changes are locked</span>
                {% endif %}
                <div class="flex h-full flex-col gap-2">
                    {% for member in party.members|sort(attribute="full_name") %}
                        <div class="flex items-center gap-2">
                            <div class="flex w-full flex-row items-center gap-2">
                                <span class="font-semibold">
                                    {{ member.full_name }}
                                    {% if member.id == leader_id %}
                                        <span class="icon-[material-symbols--crown]"></span>
                                    {% endif %}
                                    {% if member.latest_d20_transaction is not none and member.latest_d20_transaction.current_balance > 0 %}
                                        <span class="icon-[mdi--dice-d20] bg-yellow-400"></span>
                                    {% endif %}
                                </span>
                                {% if time_slot.status == 'Pre-Allocation' and request.user.id == leader_id and request.user.id != member.id %}
                                    <button
                                        class="btn ml-auto btn-sm btn-primary"
                                        hx-post="/party/promote/{{ swim(time_slot) }}/{{ swim(member) }}"
                                        hx-confirm="Are you sure you want to promote {{ member.full_name }} to party leader?"
                                    >
                                        Promote
                                    </button>
                                    <button
                                        class="btn btn-sm btn-error"
                                        hx-post="/party/remove/{{ swim(time_slot) }}/{{ swim(member) }}"
                                        hx-confirm="Are you sure you want to remove {{ member.full_name }} from the party?"
                                    >
                                        Remove
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% if time_slot.status == 'Pre-Allocation' %}
                    <button
                        class="btn mt-auto btn-sm btn-error"
                        hx-post="/party/leave/{{ swim(time_slot) }}"
                        hx-confirm="Are you sure you wish to {{ 'disband' if request.user.id == leader_id else 'leave' }} the party?"
                    >
                        {{ "Disband" if request.user.id == leader_id else "Leave" }} Party
                    </button>
                {% endif %}
            </div>
            {% if time_slot.status == 'Pre-Allocation' %}
                <div class="collapse-plus collapse px-0 md:collapse-open md:p-0!">
                    <input type="checkbox" class="peer px-0 md:hidden" />
                    <div class="collapse-title inline px-0 font-semibold peer-checked:hidden md:hidden">
                        Show QR <span class="icon-[bx--qr]"></span>
                    </div>
                    <div class="collapse-title hidden px-0 font-semibold peer-checked:inline md:hidden">
                        Hide QR <span class="icon-[bx--qr]"></span>
                    </div>
                    <div class="collapse-content flex flex-col items-center md:p-0!">
                        <QRCode :relative_url="invite_link" class="w-full rounded-box" :scale="10" />
                    </div>
                </div>
            {% endif %}
        </div>
    {% elif is_gm %}
        <h2 class="card-title">GMing</h2>
        <p>As a GM for this session, you are unable to party up with other players.</p>
    {% else %}
        <h2 class="card-title">Adventuring Solo</h2>
        {% if time_slot.status == 'Allocating' %}
            <span>Allocating - party changes are locked</span>
        {% elif time_slot.status == 'Allocated' %}
            <span>Allocated - party changes are locked</span>
        {% else %}
            <p>You are not currently in a party.</p>
            <p>Join a party to group up together!</p>
            <div class="card-actions justify-start">
                <button class="btn btn-sm btn-primary" hx-post="/party/host/{{ swim(time_slot) }}">
                    Lead a New Party
                </button>
                <button class="btn btn-sm btn-secondary" _="on click join_modal_{{ swim(time_slot) }}.showModal()">
                    Join a Party
                </button>

                <dialog id="join_modal_{{ swim(time_slot) }}" class="modal">
                    <div class="modal-box">
                        <form method="dialog">
                            <button class="btn absolute top-2 right-2 btn-circle btn-ghost btn-sm">✕</button>
                        </form>
                        <h3 class="text-lg font-bold">Join a Party</h3>
                        <p>Enter the invite code to join a party.</p>
                        <form
                            class="modal-action justify-start"
                            hx-get="/party/join/{{ swim(time_slot) }}/{invite_sqid}"
                            hx-ext="path-params"
                            hx-vals='{"alert-retarget": "#join_modal_{{ swim(time_slot) }}"}'
                        >
                            <input
                                type="text"
                                pattern="[A-Z]*"
                                class="input-bordered input w-full max-w-xs"
                                name="invite_sqid"
                                placeholder="CODE"
                                autocapitalize="characters"
                                onkeyup="this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '')"
                            />
                            <button class="btn" type="submit">Join</button>
                        </form>
                    </div>
                </dialog>
            </div>
        {% endif %}
    {% endif %}
</div>
